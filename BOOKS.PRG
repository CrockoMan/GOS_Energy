// Область 18 - книга продаж
// Область 19 - книга покупок
function writesfkniga(dogpotr,lic,dat,sum,nds,typ,mesyac)
LOCAL sel:=select(),rec:=recno(),potrstring,innstring
LOCAL Writed:=.F.
POTRSTRING=delstring(MAIN->POTREBITEL,"ИНН")
INNSTRING=appendstring(MAIN->POTREBITEL,"ИНН")
INNSTRING=alltrim(substr(INNSTRING,4,11))
select 18
IF NetAppend(10)
   replace number with DOGPOTR
   replace lic_schet with LIC
   replace data with DAT
   replace wsegosnds with SUM
   replace summands with NDS
   replace type with TYP
   replace potrebitel with POTRSTRING
   replace inn with INNSTRING
   replace okonx with MAIN->OKONX
   replace okpo with MAIN->OKPO
   replace month with mesyac
   Writed=.T.
   unlock
ELSE
     al_box({"Запись в книгу продаж  не  произведена.",;
             "Вы отказались ожидать освобождения базы",;
             "Запишите данные платежки вручную."})
ENDIF
go recno()
select(sel)
go rec
Return Writed


// Просмотр книги продаж и книги покупок
// 18 область - продажи
// 19 область - покупки
FUNCTION ViewProdag(type)
local show,spisok,is_ch,stri,Buff,ColorBuf,sel:=select()
PRIVATE recbuf,ordbuf,nm1,nm2,nm3,nm4,t1,l1,b1,r1,inp,GloMes,Cho
Kniga:=""
type:=if(type==NIL,1,type)
recbuf=recno()
ordbuf=indexord()
buff=win_save()
colorbuf=setcolor()
if urov<1
        if (.not. file(schet_share+'SFKNIGA.DBF')) .or.;
           (.not. file(schet_share+'SFKNIGA.ntx')) .or.;
           (.not. file(schet_share+'SFKNIGAp.DBF')).or.;
           (.not. file(schet_share+'SFKNIGAp.ntx'))
                sign(2)
                select(sel); go recbuf; set order to ordbuf
                setcolor(colorbuf)
                win_rest(buff)
                return NIL
        else
             if type=1
                select 18
                Kniga:="SFKNIGA"
             else
                select 19
                Kniga:="SFKNIGAP"
             endif
                if empty(fieldname(1))
                        wosst=.T.
                        al_box({"База данных не определена"})
                        return NIL
                endif
        endif
endif
spisok:={" Электроэнергия+Пеня+Повышенная+Аванс  ",;
         " Электроэнергия                  ",;
         " Пеня                            ",;
         " Повышенная                      ",;
         " Аванс      "}
is_ch:={.t.,.t.,.t.,.t.}
cho=vert_menu(spisok,"Вид книги продаж",is_ch,5,20,1,'n/w,n/g,,,r/w',.F.)
if cho==0
   PREV_REC:=-1
   RET_VAL:=2
   select(sel)
   set order to ordbuf
   go recbuf
   setcolor(colorbuf)
   win_rest(buff)
endif
mesyac:=Month_Menu()
GloMes:=Mesyac
if mesyac=0
   PREV_REC:=-1
   RET_VAL:=2
   select(sel)
   set order to ordbuf
   go recbuf
   setcolor(colorbuf)
   win_rest(buff)
   return NIL
endif
   colorwin(2,1,15,78,"n+/n")
   @ 3,2 clear to 14,77
   colorwin(3,2,14,77,"w/w")
   colorwin(1,1,1,78,"n/w")
   set color to n/w
   @ 9,25 say "Книгa "+if(type=1,"Продаж","Покупок")+" сортируется..."
   do case
      case cho=1
           stri="Электроэнергии, Пени и Повышенной"
           set filter to &KNIGA->MONTH==mesyac
      case cho=2
           stri="Электроэнергии"
           set filter to &KNIGA->TYPE==0.and.&KNIGA->MONTH==mesyac
      case cho=3
           stri="Пени"
           set filter to &KNIGA->TYPE==1.and.&KNIGA->MONTH==mesyac
      case cho=4
           stri="Повышенной"
           set filter to &KNIGA->TYPE==2.and.&KNIGA->MONTH==mesyac
      case cho=5
           stri="Аванс"
           set filter to &KNIGA->TYPE==3.and.&KNIGA->MONTH==mesyac
   endcase
   IF Type==1
   		Set Order To 2
   ENDIF
   IF Type==1
   		seek main->lic_schet
   ENDIF
   Set Order To 1
   If !found()
      go top
   Else
      Go Recno()
   Endif
   if type=1
      @ 1,0  say center('Книга продаж '+stri+" "+dbfilter(),78," ",.t.)
   else
      @ 1,0  say center('Книга покупок '+stri+" "+dbfilter(),78," ",.t.)
   endif
   declare zgl[11]
   declare fil[11]
   nm1=loarr('zgl','N докум','Лицевой','Дата','П о т р е б и т е л ь ','И Н Н',"ОКОНХ","ОКПО",'Всего с НДС',"Сумма НДС","Тип","Мес")
   nm2=loarr('fil','lic_schet',"number",'data','potrebitel','inn','okonx','okpo','wsegosnds','summands',"type","Month")
   IF Type==1
   	  inp='12000000000'
   ELSE
   	  inp='10000000000'
   ENDIF
   t1=2
   l1=1
   b1=14
   r1=77
   *********
   fsbrowse(2,1,14,77,'fil','zgl',inp,urov,kl)
   if cho>0
      set filter to
   endif
   go top
PREV_REC:=-1
RET_VAL:=2
select(sel)
set order to ordbuf
go recbuf
setcolor(colorbuf)
win_rest(buff)
return NIL





FUNCTION bookpay(dogpotr,lic,dat,sum,nds,typ,mesyac)
LOCAL potrstring,innstring
NDS=IF(NDS==NIL,ROUND(SUM*SCHET_NDS/(SCHET_NDS+100),DECIMAL),NDS)
POTRSTRING=delstring(main->potrebitel,"ИНН")
INNSTRING=appendstring(main->potrebitel,"ИНН")
INNSTRING:=alltrim(substr(INNSTRING,4,11))
MESYAC:=IF(Mesyac==NIL,month(New_date+1),Mesyac)
replace number with DOGPOTR
replace lic_schet with LIC
replace data with DAT
replace wsegosnds with SUM
replace summands with NDS
replace type with TYP
replace potrebitel with POTRSTRING
replace inn with INNSTRING
replace okonx with MAIN->OKONX
replace okpo with MAIN->OKPO
replace month with mesyac
Return NIL






// Поиск двойников в книге продаж.
FUNCTION FoundRec(sLic,sMon,sTyp)
Local IsFound:=0,Old_sel:=select(),rec:=recno(),rec18,aData[3]
AFill(aData,0)
select 18
rec18:=recno()
set order to 2
go top
seek slic
IF Found()
   DO WHILE SfKniga->Number==sLic
      IF Month==sMon.and.Type==sTyp
         aData[1]:=Lic_Schet
         aData[2]:=Data
         aData[3]:=WsegoSNds
         exit
      ENDIF
      skip
   ENDDO
ENDIF
set order to 1
go rec18
select(Old_sel)
go rec
Return aData




Function BookPaySchet()
Local myScr:=Win_Save(),myClr:=SetColor(),MRec:=Recno(),tRec,mSel:=Select()
Private PlMonth,Plat_Dat,TownString,GruzPol,TypePay:=""
PlMonth:=Mesqc(GloMes)
plat_dat:=alltrim(str(day((data))))+"  "+mesqc(month(data),1)+;
          ' '+alltrim(str(year(data)))
Select Main
tRec:=Recno()
Seek SfKniga->Number
select 77
seek main->lic_schet
if found()
   TownString=Substr(appendstring(upper(licevoj->bank),upper("г.")),3)
   TownString=Substr(townstring,1,1)+lower(substr(townstring,2))
   If Atnum("АНАПА",Upper(Licevoj->Bank))>0
      Gruzpol:=Alltrim(Alltrim(SfKniga->Potrebitel)+" "+Alltrim(Main->Adress))
   Else
      Gruzpol:=Alltrim(Alltrim(LICEVOJ->Object1)+" "+Alltrim(LICEVOJ->Object2)+Alltrim(Main->Adress))
   Endif
else
   townstring="."
   gruzpol:=alltrim(main->adress)
endif
Select Main
Go tRec
Do Case
   Case Cho=2
        Report(DDir+"SFNew.Rpt",DDir+ReportFile,140)
   Case Cho=3
        Report(DDir+"SFNewP.Rpt",DDir+ReportFile,140)
   Case Cho=4
        Report(DDir+"SFNewH.Rpt",DDir+ReportFile,140)
   Case Cho=5
        Report(DDir+"SFNewA.Rpt",DDir+ReportFile,140)
EndCase
IF Al_Box({"Отпечатать счет-фактуру"},2)==1
   Do Print_Fi
//   Copy_(DDir+ReportFile,"prn")
EndIF
Select(mSel); Go MRec
SetColor(myClr); Win_Rest(myScr)
Return NIL







// Книга покупок
Function MakeKnigaP()
Local Month:=Month_Menu("формирования книги покупок"),Scr:=Win_Save(),Clr:=SetColor(),nPay:=0,nDolg:=0
Local Rec:=Recno(),Sel:=Select(),Opl,Kol_Kl:=0,oDlg,aSizeDeskTop,aPos,oProgress,RecCount:=0
Local aOpl:={},lFirst:=.T.,I,nLic,nMonth,cDat:=""
Private PlMonth:=Mesqc(Month),cNumPlat:=""
IF Month==0
   Return NIL
ENDIF

oDlg          := XbpDialog():new(AppDesktop(),SetAppWindow(),,,,.F.)
aSizeDesktop  := AppDesktop():currentSize()
oDlg:create(oMainWindow ,, {100,50}, {aSizeDeskTop[1]-200,90} )
oDlg:title    := "Формирование книги покупок"
oDlg:SysMenu     := .F.
oDlg:Configure()
oDlg:Show()
aSizeDesktop    := oDlg:currentSize()
aPos                                            := oDlg:CurrentPos()
oProgress := ProgressBar():new(oDlg ,, {5,10}, {aSizeDeskTop[1]-18,30},, .F. )  // Progress Bar Create
oProgress:create()
oProgress:minimum := 1

Do While Lic_Schet<99999.and..not.EOF()
   RecCount:=RecCount+1
   Skip
EndDo
oProgress:maximum := RecCount

Go Top
Do While Lic_Schet<99999.and..not.EOF()
   oProgress:increment()                                                                                                                                                          // Progress Bar Increment
   nPay:=CalckMinusPay(Month,Lic_Schet)
   cDat:=GetPayDate(Month,Lic_Schet)
   IF nPay>0
//      PutBookSale(0,Month,Lic_Schet,nPay,cDat)
        PutBookSale(0,Month,Lic_Schet,nPay,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))),cDat)
   ENDIF
   Skip
EndDo
oProgress:destroy()                                                                                                                                                                                     // Progress Bar Destroy
oDlg:destroy()
DeleteFile(DDir+ReportFile)
Select(Sel);   Go Rec
SetColor(Clr); Win_Rest(Scr)
Return NIL






Function GetPayDate(nMonth,nLic)
Local dDat,cDat:="",I,Sel:=Select(),Rec:=RecNo(),nCount:=0
FOR i=1 to nMonth
		Month_:=Schet_Share+"o"+AllTrim(Str(i,2))+".dbf"
		NameInd:=Schet_Share+"o"+AllTrim(Str(i,2))+".ntx"
		Select 43
		NetUse(Month_)
		Set Index to &NameInd
		Seek nLic
		DO While Licevoj==nLIC
   		IF nCount==0
   			 dDat:=Data
   			 nCount:=nCount+1
   		ELSE
   			 IF Data>dDat
   			 		dDat:=Data
   			 ENDIF
   		ENDIF
   		Skip
		ENDDO
		Close
NEXT
cDat:=IF(nCount==0,"",DTOC(dDat))
Select(Sel)
Go Rec
Return cDat






Function CalckMinusPay(nMonth,nLic)
Local Sel:=Select(),Rec:=RecNo(),Sum:=0,Month_,NameInd
Month_:=Schet_Share+"o"+AllTrim(Str(nMonth,2))+".dbf"
NameInd:=Schet_Share+"o"+AllTrim(Str(nMonth,2))+".ntx"
select 44
NetUse(Month_)
Set Index to &NameInd
//go top
Seek nLic
DO While Licevoj==nLIC
   Sum:=Sum+IF(Summa<0,-1*Summa,0)
	 Skip
ENDDO
Select(Sel)
Go Rec
Return Sum






Function PutBookSale(_TypeOplata,_Month,_Licevoj,_Summa,_Data,_cStr)
Local Rec:=Recno(),Sel:=Select(),Num,MyRec,TmpRec
_cStr:=IF(_cStr==NIL,"",_cStr)
Select Main
TmpRec:=RecNo()
Seek _Licevoj
Select 19
IF FileLock(0)
   Append Blank
   MyRec:=RecNo()
   Go Bottom
   Num:=Lic_Schet+1
   Go Myrec
   Replace Lic_Schet With Num
   Replace Number With _Licevoj
   Replace Data With _Data
   Replace WsegoSNds With _Summa
   Replace SummaNds With Round(_Summa*Schet_Nds/(100+Schet_Nds),2)
   Replace Type With _TypeOplata
   Replace Month With _Month
   Replace NumPlat With _cStr
   Replace Potrebitel With Delstring(Main->Potrebitel,"ИНН")
   Replace Inn With Alltrim(Substr(appendstring(MAIN->POTREBITEL,"ИНН"),4,11))
   Replace Okonx With Main->Okonx
   Replace Okpo With  Main->Okpo
   Unlock
ENDIF
Select Main; GoBase(TmpRec)
Select(Sel); GoBase(Rec)
Return NIL








Function ReportBookSale()
Local Sel:=Select(),Rec:=RecNo(),Desc,cStr:="",CrLf:=Chr(13)+Chr(10)
Local oDlg,aSizeDeskTop,aPos,oProgress

oDlg          := XbpDialog():new(AppDesktop(),SetAppWindow(),,,,.F.)
aSizeDesktop  := oMainWindow:currentSize()
oDlg:create(oMainWindow ,, {100,50}, {aSizeDeskTop[1]-200,90} ) 
oDlg:title    := "Обработано" 
oDlg:SysMenu	:= .F.
oDlg:Configure()
oDlg:Show()
aSizeDesktop  := oDlg:currentSize()
aPos					:= oDlg:CurrentPos()
oProgress 		:= ProgressBar():new(oDlg ,, {5,10}, {aSizeDeskTop[1]-18,30},, .F. )
  														
oProgress:create()
oProgress:minimum := 1
oProgress:maximum := RecCount()

go top
nMonth:=Month
cStr:=cStr+center("К Н И Г А  "+if(select()==18,"П Р О Д А Ж","П О К У П О К"),130," ")+crlf
cStr:=cStr+"Покупатель "+alltrim(SchetNameOrg)+crlf
cStr:=cStr+"Идентификационный номер покупателя "+alltrim(schetInn)+"/"+AllTrim(SchetKpp)+crlf
cStr:=cStr+"Покупка за "+mesqc(nmonth)+" "+AllTrim(Str(Year(New_date)))+"г. "+crlf
cStr:=cStr+"┌─────────────────┬────────────┬──────────────┬─────────────────────────────────────────┬────────────┬──────────────┬──────────────┬──────────────┬───────────────────────────────┬───────────────────────────┬─────────────────────┬─────────────────────┬───────┐"+crlf
cStr:=cStr+"│  Дата и номер   │Дата  оплаты│Дата  принятия│      Наименование продавца              │Идентификаци│              │Страна проис- │Всего покупок,│      В том числе покупки      │    В том числе покупки    │ В том числе покупки │ В том числе покупки │Покупки│"+crlf
cStr:=cStr+"│     счета       │   счета-   │на учет това- │                                         │онный номер │              │хождения това-│включая НДС   │      облагаемые налогом       │    облагаемые налогом     │ облагаемые налогом  │ облагаемые налогом  │освобож│"+crlf
cStr:=cStr+"│    фактуры      │  фактуры   │ров (работ,   │                                         │ продавца   │              │ра. Номер     │              │          по ставке            │        по ставке          │     по ставке       │     по ставке       │даемые │"+crlf
cStr:=cStr+"│  продавца       │  продавца  │услуг) имуще- │                                         │            │              │ таможенной   │              ├───────────────────────────────┼───────────────────────────┼─────────────────────┼─────────────────────│  от   │"+crlf
cStr:=cStr+"│                 │            │ственных прав │                                         │            │              │ декларации   │              │              18%              │           10%             │           0%        │          20%        │налога │"+crlf
cStr:=cStr+"│                 │            │              │                                         │            │              │              │              ├───────────────┬───────────────┼────────────┬──────────────┼───────────┬─────────┼───────────┬─────────│       │"+crlf
cStr:=cStr+"│                 │            │              │                                         │            │              │              │              │   Стоимость   │   Сумма НДС   │Стоимость   │   Сумма НДС  │Стоимость  │Сумма НДС│Стоимость  │Сумма НДС│       │"+crlf
cStr:=cStr+"│                 │            │              │                                         │            │              │              │              │   покупок без │               │покупок без │              │покупок без│         │покупок без│         │       │"+crlf
cStr:=cStr+"│                 │            │              │                                         │            │              │              │              │   НДС         │               │  НДС       │              │  НДС      │         │   НДС     │         │       │"+crlf
cStr:=cStr+"├─────────────────┼────────────┼──────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼──────────────┼───────────────┼───────────────┼────────────┼──────────────┼───────────┼─────────┼───────────┼─────────┼───────┤"+crlf
cStr:=cStr+"│        1        │     2      │      3       │               4                         │     5a     │      5б      │      6       │       7      │       8а      │       8б      │     9а     │       9б     │     10а   │   10б   │     11а   │   11б   │  12   │"+crlf
cStr:=cStr+"├─────────────────┼────────────┼──────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼──────────────┼───────────────┼───────────────┼────────────┼──────────────┼───────────┼─────────┼───────────┼─────────┼───────┤"+crlf
Do While !EOF()
   	oProgress:increment()																				// Progress Bar Increment
		cStr:=cStr+"│"+dtoc(data)+" "+str(lic_schet,6,0)+"│ "+Substr(NumPlat+Space(10),1,10)+" │  "+dtoc(data)+"  │"+;
               potrebitel+''+str(number,6,0)+"│"+substr(inn,1,12)+;
        "│"+substr("за "+Mesqc(nMonth)+space(11),1,14)+"│              │"+;
        str(wsegosnds,14,Decimal)+"│"+IF(sfkniga->type#3,str((wsegosnds-summands),15,2),Space(15))+;
      	"│"+str(summands,15,2)+;
        "│            │              │           │         │           │         │       │"+CrLf
	
	SKIP
ENDDO
cStr:=cStr+"└─────────────────┴────────────┴──────────────┴─────────────────────────────────────────┴────────────┴──────────────┴──────────────┴──────────────┴───────────────┴───────────────┴────────────┴──────────────┴───────────┴─────────┴───────────┴─────────┴───────┘"+crlf

Desc:=fcreate(Ddir+"otchet.gkv")
FWrite(Desc,cStr)
FClose(Desc)

oProgress:destroy()																							// Progress Bar Destroy
oDlg:Destroy()

Select(Sel)
Go Rec
Return NIL





Function PutBookPay(_TypeOplata,_Month,_Licevoj,_Summa,_Data,_cStr)
Local Rec:=Recno(),Sel:=Select(),Num,MyRec,TmpRec
_cStr:=IF(_cStr==NIL,"",_cStr)
Select Main
TmpRec:=RecNo()
Seek _Licevoj
Select 18
IF FileLock(0)
   Append Blank
   MyRec:=RecNo()
   Go Bottom
   Num:=Lic_Schet+1
   Go Myrec
   Replace Lic_Schet With Num
   Replace Number With _Licevoj
   Replace Data With _Data
   Replace WsegoSNds With _Summa
   Replace SummaNds With Round(_Summa*Schet_Nds/(100+Schet_Nds),2)
   Replace Type With _TypeOplata
   Replace Month With _Month
   Replace NumPlat With _cStr
   Replace Potrebitel With Delstring(Main->Potrebitel,"ИНН")
   Replace Inn With Alltrim(Substr(appendstring(MAIN->POTREBITEL,"ИНН"),4,11))
   Replace Okonx With Main->Okonx
   Replace Okpo With  Main->Okpo
   Unlock
ENDIF
Select Main; GoBase(TmpRec)
Select(Sel); GoBase(Rec)
Return NIL










// Книга продаж по реализации
Function MakeSfKniga
Local Month:=Month_Menu("формирования книги продаж"),Scr:=Win_Save(),Clr:=SetColor(),nPay:=0,nDolg:=0
Local Rec:=Recno(),Sel:=Select(),Opl,Kol_Kl:=0,oDlg,aSizeDeskTop,aPos,oProgress,RecCount:=0
Local aOpl:={},lFirst:=.T.,I,nLic,nMonth
Private PlMonth:=Mesqc(Month),cNumPlat:=""
IF Month==0
   Return NIL
ENDIF

oDlg          := XbpDialog():new(AppDesktop(),SetAppWindow(),,,,.F.)
aSizeDesktop  := AppDesktop():currentSize()
oDlg:create(oMainWindow ,, {100,50}, {aSizeDeskTop[1]-200,90} )
oDlg:title    := "Формирование книги продаж"
oDlg:SysMenu     := .F.
oDlg:Configure()
oDlg:Show()
aSizeDesktop    := oDlg:currentSize()
aPos                                            := oDlg:CurrentPos()
oProgress := ProgressBar():new(oDlg ,, {5,10}, {aSizeDeskTop[1]-18,30},, .F. )  // Progress Bar Create
oProgress:create()
oProgress:minimum := 1

Do While Lic_Schet<99999.and..not.EOF()
   RecCount:=RecCount+1
   Skip
EndDo
oProgress:maximum := RecCount

Go Top
Do While Lic_Schet<99999.and..not.EOF()
   oProgress:increment()                                                                                                                                                          // Progress Bar Increment
   nPay:=CalckPay(Month,Lic_Schet,.f.)
   Opl:=GetSum(Lic_schet,Month) //;  Opl:=Opl+Round(Opl*Schet_Nds/100,Decimal)
   nDolg:=GetDolg(Lic_Schet,IF(Month-1=0,13,Month-1))
   IF Opl!=0
      PutBookPay(0,Month,Lic_Schet,Opl,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))))
   ENDIF
//-------------------------------- запись в нигу продаж авансов
   lFirst:=.T.
   nLic:=Lic_Schet
   nMonth:=Month
//                              nPay:=CalckPay(nMonth,nLic,.f.)
//                              Opl:=SfKniga->Wsegosnds
//                              nDolg:=GetDolg(nLic,IF(nMonth-1=0,13,nMonth-1))
   Opl:=Opl+nDolg

/*IF nLic==52
         @ 1,0 Say nPay-Opl
ENDIF           */
   IF nPay-Opl>0
      aOpl:=aGetOpl(nLic,nMonth)
      For i=1 To Len(aOpl)
/*IF nLic==52
         @ 2,0 Say i
         @ 2, 10 Say Len(aOpl)
         @ 3,0 Say aOpl[i]
ENDIF           */
          Opl:=Opl-aOpl[i][1]
          IF Opl<0
             IF lFirst
                aOpl[i][1]:=-1*Opl
                lFirst:=.F.
             ENDIF
          ELSE
             aOpl[i][1]:=0
          ENDIF
          IF aOpl[i][1]>0
             PutBookPay(3,nMonth,nLic,aOpl[i][1],ctod(Alltrim(Str(LastDayOm(nMonth)))+"."+Alltrim(Str(nMonth))+"."+Alltrim(Str(Year(New_date)))),aOpl[i][2])
          ENDIF
/*IF nLic==52
Inkey(0)
ENDIF           */
      NEXT
   ENDIF
//--------------------------------
   Skip
EndDo
oProgress:destroy()                                                                                                                                                                                     // Progress Bar Destroy
oDlg:destroy()
DeleteFile(DDir+ReportFile)
Select(Sel);   Go Rec
SetColor(Clr); Win_Rest(Scr)
Return NIL











FUNCTION Calc_Nds(SUM)
RETURN ROUND(SUM*SCHET_NDS/(SCHET_NDS+100),DECIMAL)









//----------------------------------------------- Книга продаж по отгрузке
FUNCTION MakeKnigaSF()
LOCAL scre:=win_save(),color:=setcolor(),sel:=select(),rec:=recno(),ls
LOCAL snum:=0,enum:=99999,sdat:=New_date-30,edat:=New_date+1,temp_,kol_kl
LOCAL CrLf:=chr(13)+chr(10),itog1:=0,itog2:=0,itog3:=0,nmonth,p1,p2,ps,ntx
LOCAL itog4:=0,itog5:=0,itog6:=0,itog7:=0,itog8:=0,itog9:=0,OldFilter:=DbFilter()
LOCAL page:=0,string:=0,pagelen:=42,first:=.t.,s1:=-1,innstring,potrstring
LOCAL lic_uniq:={},sum_opl:=0,mesyac,IsCentury,VsegoProdag:=0,nType,oDlg,aSizeDeskTop,oProgress
NMonth:=SfKniga->Month
nType :=SfKniga->Type
// При нажатии ESС - выходим из формирования
if nmonth==0
   setcolor(color)
   win_rest(scre)
   select(sel)
   go rec
   prev_rec=-1
   ret_val=2
   RETURN NIL
else

   do case
      case sfkniga->type==0
           p2:=schet_share+'o'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" электроэнергия"
      case sfkniga->type==1
           p2:=schet_share+'p'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" % банка"
      case sfkniga->type==2
           p2:=schet_share+'h'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" повышенная"
      case sfkniga->type==3
           p2:=schet_share+'a'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" аванс"
   endcase
endif
//obrabot("Формирование отчета по книге")

oDlg          := XbpDialog():new(AppDesktop(),SetAppWindow(),,,,.F.)
aSizeDesktop  := AppDesktop():currentSize()
oDlg:create(oMainWindow ,, {100,50}, {aSizeDeskTop[1]-200,90} )
oDlg:title    := "Расчет книги продаж"
oDlg:SysMenu     := .F.
oDlg:Configure()
oDlg:Show()
aSizeDesktop    := oDlg:currentSize()
aPos                                            := oDlg:CurrentPos()
oProgress := ProgressBar():new(oDlg ,, {5,10}, {aSizeDeskTop[1]-18,30},, .F. )  // Progress Bar Create
oProgress:create()
oProgress:minimum := 1
oProgress:maximum := RecCount()


go top
desc:=fcreate(Ddir+"otchet.gkv")
fwrite(desc,center("К Н И Г А  "+if(select()==18,"П Р О Д А Ж","П О К У П О К"),130," ")+crlf)
fwrite(desc,"Налогоплательщик-продавец "+alltrim(SchetNameOrg)+crlf)
fwrite(desc,"Идентификационный номер налогоплательщика-продавца "+alltrim(schetInn)+"/"+AllTrim(SchetKpp)+crlf)
fwrite(desc,"Продажа за "+mesqc(nmonth)+" "+AllTrim(Str(Year(New_date)))+"г. "+KnigaString+crlf)
fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬─────────────────────┬──────────────┬───────────────────────────────┬─────────────────────────┬───────────────────┬─────────────────────────┬────────┐"+crlf)
fwrite(desc,"│ Дата и номер  │      Наименование покупателя            │Идентификаци│              │     Дата оплаты     │Всего продаж, │      В том числе продажи      │   В том числе продажи   │В том числе продажи│   В том числе продажи   │Продажи,│"+crlf)
fwrite(desc,"│    счета      │                                         │онный номер │              │    счеты-фактуры    │включая НДС   │      облагаемые налогом       │   облагаемые налогом    │облагаемые налогом │   облагаемые налогом    │освобож-│"+crlf)
fwrite(desc,"│   фактуры     │                                         │ покупателя │              │       продавца      │              │          по ставке            │       по ставке         │     по ставке     │       по ставке         │даемые  │"+crlf)
fwrite(desc,"│ поставщика    │                                         │            │              │                     │              ├───────────────────────────────┼─────────────────────────┼───────────────────┼─────────────────────────┤  от    │"+crlf)
fwrite(desc,"│               │                                         │            │              │                     │              │              18%              │           10%           │        0%         │           20%           │налога  │"+crlf)
fwrite(desc,"│               │                                         │            │              │                     │              ├───────────────┬───────────────┼────────────┬────────────┼───────────────────┼────────────┬────────────┤        │"+crlf)
fwrite(desc,"│               │                                         │            │              │                     │              │   Стоимость   │   Сумма НДС   │Стоимость   │   Сумма НДС│                   │ Стоимость  │ Сумма НДС  │        │"+crlf)
fwrite(desc,"│               │                                         │            │              │                     │              │   продаж без  │               │продаж без  │            │                   │ продаж без │            │        │"+crlf)
fwrite(desc,"│               │                                         │            │              │                     │              │   НДС         │               │НДС         │            │                   │ НДС        │            │        │"+crlf)
fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼─────────────────────┼──────────────┼───────────────┼───────────────┼────────────┼────────────┼───────────────────┼────────────┼────────────┼────────┤"+crlf)
fwrite(desc,"│      1        │               2                         │     3      │      3a      │           3б        │       4      │       5a      │       5б      │    6a      │       6б   │         7         │    8a      │       8б   │   9    │"+crlf)
fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼─────────────────────┼──────────────┼───────────────┼───────────────┼────────────┼────────────┼───────────────────┼────────────┼────────────┼────────┤"+crlf)

//fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬──────────────┬───────────────┬───────────────┬────────────┬────────────┬───────────────────┬────────────┬────────────┬────────┐"+crlf)
//fwrite(desc,"│      1        │               2                         │     3      │      3a      │       4      │       5a      │       5б      │    6a      │       6б   │         7         │    8a      │       8б   │   9    │"+crlf)
//fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼───────────────┼───────────────┼────────────┼────────────┼───────────────────┼────────────┼────────────┼────────┤"+crlf)
string=17
first=.t.
go top
do while !eof()
   if month=nmonth.and.nType==Type
      VsegoProdag:=VsegoProdag+1
//   if lic_schet>=snum.and.lic_schet<=enum.and.data>=sdat.and.data<=edat
      if at(upper("Кредит"),upper(potrebitel))>0
         s1:=lic_schet
         exit
      endif
   endif
   skip
enddo
go top

MySum:=0
IsCentury:=CSetCent()
Set Century Off
//temp_=39/VsegoProdag
//kol_kl=0
do while lic_schet<99999.and..not.eof()
   if string>=pagelen
      page++
      string=4
      fwrite(desc,"└───────────────┴─────────────────────────────────────────┴────────────┴──────────────┴─────────────────────┴──────────────┴───────────────┴───────────────┴────────────┴────────────┴───────────────────┴────────────┴────────────┴────────┘"+crlf)

      fwrite(desc,chr(12)+space(165)+"Страница "+alltrim(str(page))+crlf)
      fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬─────────────────────┬──────────────┬───────────────┬───────────────┬────────────┬────────────┬───────────────────┬────────────┬────────────┬────────┐"+crlf)
			fwrite(desc,"│      1        │               2                         │     3      │      3a      │          3б         │       4      │       5a      │       5б      │    6a      │       6б   │         7         │    8a      │       8б   │   9    │"+crlf)
			fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼─────────────────────┼──────────────┼───────────────┼───────────────┼────────────┼────────────┼───────────────────┼────────────┼────────────┼────────┤"+crlf)
   endif
   if month==nmonth.and.Type==nType
//   if lic_schet>=snum.and.lic_schet<=enum.and.data>=sdat.and.data<=edat
            oProgress:increment()                                                                                                                                                               // Progress Bar Increment
//      kol_kl=kol_kl+temp_
//      colorwin(12,21,12,21+kol_kl,'n/n')
      fwrite(desc,"│"+dtoc(data)+" "+str(lic_schet,6,0)+"│"+;
      potrebitel+''+str(number,6,0)+"│"+substr(inn,1,12)+;
      "│"+substr("за "+Mesqc(nMonth)+space(11),1,14)+"│"+;
      IF(Type==3,Substr(NumPlat+Space(20),1,21),Space(21))+"│"+str(wsegosnds,14,Decimal)+;
      "│"+IF(sfkniga->type#3,str((wsegosnds-summands),15,2),Space(15))+"│"+str(summands,15,2)+"│"+;
      "            │            │                   │            │            │        │"+CrLf)
      itog1=itog1+wsegosnds; itog2=itog2+(wsegosnds-summands)
      itog3=itog3+summands
      ls=number
      MySum:=MySum+WsegoSNds
      string++

//      select(ps)
   endif
   skip
enddo
IF IsCentury
   Set Century On
ELSE
   Set Century Off
ENDIF

itog3=Round(Itog1*Schet_Nds/(100+Schet_Nds),2)
itog2=itog1-itog3
fwrite(desc,"└───────────────┴─────────────────────────────────────────┴────────────┴──────────────┴─────────────────────┴──────────────┴───────────────┴───────────────┴────────────┴────────────┴───────────────────┴────────────┴────────────┴────────┘"+crlf)
//fwrite(desc,+space(20)+"Всего:"+space(60)+str(itog1,15,2)+" "+;
//            str(itog2,15,2)+" "+str(itog3,15,2)+" "+str(itog4,14,Decimal)+;
//            " "+str(itog5,14,Decimal)+" "+str(itog6,14,Decimal)+crlf+chr(12))
fwrite(desc,+space(20)+"Всего:"+space(60)+str(itog1,15,2)+" "+;
            IF(nType#3,str(itog2,15,2),Space(15))+" "+str(itog3,15,2)+crlf+crlf)
FWrite(Desc,"      Главный бухгалтер                   _________________         "+NameBuh+CrLf+CrLf+CrLf)
FWrite(Desc,"      Индивидуальный предприниматель      _________________         "+CrLf+CrLf)
FWrite(Desc,"Реквизиты свидетельства о государственной регистрации индивидуальго предпринимателя"+CrLf+CrLf)
FWrite(Desc,"___________________________________________________________________________________"+CrLf)
fclose(desc)
oProgress:destroy()                                                                                                                                                             // Progress Bar Increment
oDlg:destroy()
setcolor(color)
win_rest(scre)
select(sel)
Set Filter To &OldFilter
go rec
prev_rec=-1
ret_val=2
return NIL








/*

//----------------------------------------------- Книга продаж по оплате
FUNCTION MakeKnigaSF()
LOCAL scre:=win_save(),color:=setcolor(),sel:=select(),rec:=recno(),ls
LOCAL snum:=0,enum:=99999,sdat:=New_date-30,edat:=New_date+1,temp_,kol_kl
LOCAL CrLf:=chr(13)+chr(10),itog1:=0,itog2:=0,itog3:=0,nmonth,p1,p2,ps,ntx
LOCAL itog4:=0,itog5:=0,itog6:=0,itog7:=0,itog8:=0,itog9:=0,OldFilter:=DbFilter()
LOCAL page:=0,string:=0,pagelen:=42,first:=.t.,s1:=-1,innstring,potrstring
LOCAL lic_uniq:={},sum_opl:=0,mesyac,IsCentury,VsegoProdag:=0,nType
//if al_box({"Сформировать отчет по книге "+if(select()=18,"продаж","покупок")},2)==2
//   Return NIL
//endif
//nmonth:=month_menu()
NMonth:=SfKniga->Month
nType :=SfKniga->Type
// При нажатии ESС - выходим из формирования
if nmonth==0
   setcolor(color)
   win_rest(scre)
   select(sel)
   go rec
   prev_rec=-1
   ret_val=2
   RETURN NIL
else
   ps:=select()
   if .not.file(Ddir+'opl.dbf')
      copy_(schet_share+"o"+alltrim(str(nmonth))+'.dbf',Ddir+"opl.dbf")
   endif
   obrabot("Сбор всех оплат за "+mesqc(nmonth))
   p1=Ddir+'opl.dbf'
   ntx:=Ddir+'opl.ntx'
   select 120
   use &p1 EXCLUSIVE alias opl1
   index on licevoj to &ntx
   zap

   do case
      case sfkniga->type==0
           p2:=schet_share+'o'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" электроэнергия"
      case sfkniga->type==1
           p2:=schet_share+'p'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" % банка"
      case sfkniga->type==2
           p2:=schet_share+'h'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" повышенная"
      case sfkniga->type==3
           p2:=schet_share+'a'+alltrim(str(int(nmonth)))+".dbf"
           KnigaString:=" абонированная"
   endcase
   select 121
   netuse(p2,,,'opl2')
   go top

   temp_=39/reccount()
   kol_kl=0
   do while !eof()
      kol_kl=kol_kl+temp_
      colorwin(12,21,12,21+kol_kl,'n/n')
      select opl1
      @ 1,0 say RecCount()
      IF Opl2->Licevoj<99999
         IF NetAppend()
            replace opl1->vid_dokum with opl2->vid_dokum
            replace opl1->num_dokum with opl2->num_dokum
            replace opl1->licevoj with opl2->licevoj
            replace opl1->summa with if(atnum("ВОЗВ",upper(opl2->vid_dokum))#0,opl2->summa*-1,opl2->summa)
            replace opl1->data with opl2->data
            replace opl1->reestr with opl2->reestr
            UNLOCK
         ENDIF
      ENDIF
      select opl2
      skip
   enddo
   Clear Typeahead
//   @ 1,0 say "2"
//   Inkey(1)
//   select opl2
   Select 121
   use
   select(ps)
   Set Filter To
   Go Top
endif
obrabot("Формирование отчета по книге")
//@ 1,0 say "1"
//inkey(1)
//al_box({"1"})
go top
desc:=fcreate(Ddir+"otchet.gkv")
fwrite(desc,center("К Н И Г А  "+if(select()==18,"П Р О Д А Ж","П О К У П О К"),130," ")+crlf)
fwrite(desc,"Налогоплательщик-продавец "+alltrim(schet_poluch)+crlf)
fwrite(desc,"Идентификационный номер налогоплательщика-продавца "+alltrim(schet_naz1)+crlf)
fwrite(desc,"Продажа за "+mesqc(nmonth)+" "+AllTrim(Str(Year(New_date)))+"г. "+KnigaString+crlf)
fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬──────────────┬───────────────────────────────┬────────────────────────────────────────────┐"+crlf)
fwrite(desc,"│Дата и номер   │      Наименование покупателя            │Идентификаци│              │Всего продаж, │      В том числе продажи      │              Частичная оплата              │"+crlf)
fwrite(desc,"│   счета       │                                         │онный номер │              │включая НДС   │      облагаемые налогом       ├──────────────┬──────────────┬──────────────┤"+crlf)
fwrite(desc,"│  фактуры      │                                         │ покупателя │              │              │          по ставке            │Сумма без НДС │     НДС      │ Сумма с НДС  │"+crlf)
fwrite(desc,"│поставщика     │                                         │            │              │              ├───────────────────────────────┤              │              │              │"+crlf)
fwrite(desc,"│               │                                         │            │              │              │              18%              │              │              │              │"+crlf)
fwrite(desc,"│               │                                         │            │              │              ├───────────────┬───────────────┤              │              │              │"+crlf)
fwrite(desc,"│               │                                         │            │              │              │   Стоимость   │   Сумма НДС   │              │              │              │"+crlf)
fwrite(desc,"│               │                                         │            │              │              │   продаж без  │               │              │              │              │"+crlf)
fwrite(desc,"│               │                                         │            │              │              │   НДС         │               │              │              │              │"+crlf)
fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼───────────────┼───────────────┼──────────────┼──────────────┼──────────────┤"+crlf)
fwrite(desc,"│      1        │               2                         │     3      │      3a      │       4      │       5a      │       5б      │       8      │       9      │      10      │"+crlf)
fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼───────────────┼───────────────┼──────────────┼──────────────┼──────────────┤"+crlf)
string=17
first=.t.
go top
do while !eof()
   if month=nmonth.and.nType==Type
      VsegoProdag:=VsegoProdag+1
//   if lic_schet>=snum.and.lic_schet<=enum.and.data>=sdat.and.data<=edat
      if at(upper("Кредит"),upper(potrebitel))>0
         s1:=lic_schet
         exit
      endif
   endif
   skip
enddo
go top
if s1==-1
   al_box({"Сумма кредиторской задолженности не найдена"})
endif
MySum:=0
IsCentury:=CSetCent()
Set Century Off
temp_=39/VsegoProdag
kol_kl=0
do while lic_schet<99999.and..not.eof()
   if string>=pagelen
      page++
      string=4
      fwrite(desc,"└───────────────┴─────────────────────────────────────────┴────────────┴──────────────┴──────────────┴───────────────┴───────────────┴──────────────┴──────────────┴──────────────┘"+crlf)
      fwrite(desc,chr(12)+space(165)+"Страница "+alltrim(str(page))+crlf)
      fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬──────────────┬───────────────┬───────────────┬──────────────┬──────────────┬──────────────┐"+crlf)
      fwrite(desc,"│      1        │               2                         │     3      │      3a      │       4      │       5a      │       5б      │       8      │       9      │      10      │"+crlf)
      fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼───────────────┼───────────────┼──────────────┼──────────────┼──────────────┤"+crlf)
   endif
   if month==nmonth.and.Type==nType
//   if lic_schet>=snum.and.lic_schet<=enum.and.data>=sdat.and.data<=edat
      kol_kl=kol_kl+temp_
      colorwin(12,21,12,21+kol_kl,'n/n')
      fwrite(desc,"│"+dtoc(data)+" "+str(lic_schet,6,0)+"│"+;
      potrebitel+''+str(number,6,0)+"│"+substr(inn,1,12)+;
      "│"+substr("за "+Mesqc(nMonth)+space(11),1,14)+"│"+str(wsegosnds,14,Decimal)+;
      "│"+str((wsegosnds-summands),15,2)+"│"+str(summands,15,2)+"│")
      itog1=itog1+wsegosnds; itog2=itog2+(wsegosnds-summands)
      itog3=itog3+summands
      ls=number
      MySum:=MySum+WsegoSNds
      select opl1
      seek ls
      if found()
         itog7:=0
         Do While LICEVOJ==LS
            itog7:=itog7+summa
            itog4:=itog4+(summa-calc_nds(summa))
            itog5:=itog5+calc_nds(summa)
            itog6:=itog6+summa
            skip
         Enddo
            fwrite(desc,str(itog7-calc_nds(itog7),14,2)+"│"+;
                        str(calc_nds(itog7),14,2)+"│"+str(itog7,14,2)+"│"+crlf)
// Удаление найденной оплаты...      ----------------------vvvvvvvvvvvvvvvvvv
         do while .t.
            seek ls
            if found()
               delete
            else
               exit
            endif
        enddo
//---------------------------------------------------------^^^^^^^^^^^^^^^^^^
      else
         fwrite(desc,"              │              │              │"+crlf)
      endif
      string++
      select(ps)
   endif
   skip
enddo
IF IsCentury
   Set Century On
ELSE
   Set Century Off
ENDIF
//----------------------------------------------- Вывод первой строки еще раз
IF S1>0
   seek s1
   fwrite(desc,"│"+dtoc(data)+" "+str(lic_schet,4,0)+"│"+;
          potrebitel+''+str(number,6,0)+"│"+substr(inn,1,12)+;
          "│"+space(14)+"│"+str(-1*wsegosnds,14,Decimal)+;
          "│"+str(-1*(wsegosnds-summands),15,2)+"│"+str(-1*summands,15,2)+"│")
   fwrite(desc,"              │              │              │"+crlf)
   itog1=itog1-wsegosnds; itog2=itog2-wsegosnds-summands
   itog3=itog3-summands
ENDIF
//------------------------------------------------------- Подбивка результата
itog2=itog1-itog3
select opl1
set unique on
index on licevoj to &ntx
go top
do while !eof()
   aadd(lic_uniq,licevoj)
   skip
enddo
set unique off
index on licevoj to &ntx
if reccount()>0
   if al_box({"Найдены оплаты, не вошедшие в книгу"},2,{" Отпечатать "," Закончить "})==1
    temp_=(39-kol_kl)/len(lic_uniq)
    for Mystep=1 to len(lic_uniq)
      kol_kl=kol_kl+temp_
      colorwin(12,21,12,21+kol_kl,'n/n')
      go top
      sum_opl:=0
      do while !eof()
         if lic_uniq[Mystep]==licevoj
            itog4:=itog4+(summa-calc_nds(summa))
            itog5:=itog5+calc_nds(summa)
            itog6:=itog6+summa
            itog7:=itog7+summa
            itog9:=itog9+summa
            sum_opl=sum_opl+summa
         endif
         skip
      enddo
      seek main->lic_schet
      IF string>=pagelen
         page++
         string=4
         fwrite(desc,"└───────────────┴─────────────────────────────────────────┴────────────┴──────────────┴──────────────┴───────────────┴───────────────┴──────────────┴──────────────┴──────────────┘"+CrLf)
         fwrite(desc,chr(12)+space(165)+"Страница "+alltrim(str(page))+crlf)
         fwrite(desc,"┌───────────────┬─────────────────────────────────────────┬────────────┬──────────────┬──────────────┬───────────────┬───────────────┬──────────────┬──────────────┬──────────────┐"+CrLf)
         fwrite(desc,"│      1        │               2                         │     3      │      3a      │       4      │       5a      │       5б      │       8      │       9      │      10      │"+CrLf)
         fwrite(desc,"├───────────────┼─────────────────────────────────────────┼────────────┼──────────────┼──────────────┼───────────────┼───────────────┼──────────────┼──────────────┼──────────────┤"+CrLf)
      ENDIF
         select main
         seek lic_uniq[Mystep]
         if .not.found()
            fwrite(desc,"│               │                                         │            │       │      │              │               │               │")
         else
            INNSTRING=appendstring(MAIN->POTREBITEL,"ИНН")
            INNSTRING=alltrim(substr(INNSTRING,4,11))
            INNSTRING=substr(INNSTRING+space(12-len(INNSTRING)),1,12)
            POTRSTRING=delstring(MAIN->POTREBITEL,"ИНН")
            potrstring=substr(potrstring+space(35-len(potrstring)),1,35)
            fwrite(desc,"│"+dtoc(opl1->data)+" "+space(4)+"│"+;
            potrstring+str(opl1->licevoj,6,0)+"│"+substr(innstring,1,12)+;
            "│              │"+;
            "              │               │               │")
         endif
         select opl1
         fwrite(desc,str(sum_opl-calc_nds(sum_opl),14,2)+"│"+;
                     str(calc_nds(sum_opl),14,2)+"│"+;
                     str(sum_opl,14,2)+"│"+crlf)
         string++
    next
   endif
endif
fwrite(desc,"└───────────────┴─────────────────────────────────────────┴────────────┴──────────────┴──────────────┴───────────────┴───────────────┴──────────────┴──────────────┴──────────────┘"+crlf)
fwrite(desc,+space(20)+"Всего:"+space(60)+str(itog1,15,2)+" "+;
            str(itog2,15,2)+" "+str(itog3,15,2)+" "+str(itog4,14,Decimal)+;
            " "+str(itog5,14,Decimal)+" "+str(itog6,14,Decimal)+crlf+chr(12))
fclose(desc)
//select opl1;  use               // Закрытие базы собранных оплат
select 120
close
select 121
close
setcolor(color)
win_rest(scre)
select(sel)
//DbSetFilter(OldFilter)
Set Filter To &OldFilter
go rec
prev_rec=-1
ret_val=2
return NIL
*/






/*
//------------------------------------------- Книга продаж по оплате
Function MakeSfKniga
Local Month:=Month_Menu("формирования книги продаж"),Scr:=Win_Save(),Clr:=SetColor()
Local Rec:=Recno(),Sel:=Select(),Opl,Kol_Kl:=0
Private PlMonth:=Mesqc(Month)
IF Month==0
   Return NIL
ENDIF
Obrabot("Заполнение книги продаж за "+Mesqc(Month))
Go Top
Fclose(Fcreate(DDir+ReportFile))
Do While Lic_Schet<99999.and..not.EOF()
   @ 1,0 say Lic_Schet
   Kol_Kl=Kol_Kl+39/reccount()
   ColorWin(12,21,12,21+kol_kl,'n/n')
   Opl:=CalckPay(Month,Lic_Schet,.f.)
   IF Opl!=0
      PutBookPay(0,Month,Lic_Schet,Opl,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))))
      Report(DDir+"SfNew.Rpt",DDir+"TmpFile.Tmp",150)
      AppendFile(DDir+"TmpFile.Tmp",DDir+ReportFile,,,,.F.)
   ENDIF
   Opl:=CalckPay(Month,Lic_Schet,.f.,2)
   IF Opl!=0
      PutBookPay(1,Month,Lic_Schet,Opl,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))))
      Report(DDir+"SfNewp.Rpt",DDir+"TmpFile.Tmp",150)
      AppendFile(DDir+"TmpFile.Tmp",DDir+ReportFile,,,,.F.)
   ENDIF
   Opl:=CalckPay(Month,Lic_Schet,.f.,3)
   IF Opl!=0
      PutBookPay(2,Month,Lic_Schet,Opl,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))))
      Report(DDir+"SfNewH.Rpt",DDir+"TmpFile.Tmp",150)
      AppendFile(DDir+"TmpFile.Tmp",DDir+ReportFile,,,,.F.)
   ENDIF
   Opl:=CalckPay(Month,Lic_Schet,.f.,4)
   IF Opl!=0
      PutBookPay(3,Month,Lic_Schet,Opl,ctod(Alltrim(Str(LastDayOm(Month)))+"."+Alltrim(Str(Month))+"."+Alltrim(Str(Year(New_date)))))
      Report(DDir+"SfNewA.Rpt",DDir+"TmpFile.Tmp",150)
      AppendFile(DDir+"TmpFile.Tmp",DDir+ReportFile,,,,.F.)
   ENDIF
   Skip
EndDo
DeleteFile(DDir+ReportFile)
Select(Sel);   Go Rec
SetColor(Clr); Win_Rest(Scr)
Return NIL
*/